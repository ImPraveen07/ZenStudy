<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background:#e0e7ff; margin:0; min-height:100vh; }
    .user-bar { display:flex; align-items:center; background:#6366f1; color:#fff; padding:12px 18px; position:relative; flex-wrap:wrap; gap:8px; }
    .user-img { width:54px; height:54px; border-radius:50%; object-fit:cover; border:2px solid #fff; margin-right:16px; cursor:pointer; box-shadow:0 2px 8px #6366f155; transition: box-shadow 0.2s; background:#fff; }
    .user-img:hover { box-shadow:0 4px 16px #6366f1aa; }
    .user-info { font-size:1.1em; font-weight:600; flex:1 1 auto; min-width:0; word-break:break-all; }
    .user-id-copy { margin-left:8px; font-size:0.98em; color:#6366f1; background:#fff; border-radius:6px; padding:2px 8px; border:1.2px solid #6366f1; cursor:pointer; user-select:all; transition: background 0.2s, color 0.2s; font-weight:700; position:relative; min-width:60px; text-align:center; display:inline-block; }
    .user-id-copy.copied { color:#fff; background:#6366f1; border-color:#6366f1; }
    #logoutBtn { position:fixed; top:18px; right:18px; z-index:999; background:#fff; color:#6366f1; font-weight:700; border-radius:8px; border:1.5px solid #6366f1; padding:8px 18px; cursor:pointer; box-shadow:0 2px 8px #6366f122; transition:background 0.2s, color 0.2s; }
    #logoutBtn:hover { background:#6366f1; color:#fff; }

    /* Subject Widget */
    .subject-widget { width:260px; padding:20px; border-radius:20px; background:#fff; box-shadow:0 10px 25px rgba(0,0,0,0.15); text-align:center; font-family:'Inter', sans-serif; margin:20px auto; }
    .subject-header { font-size:1.1em; font-weight:700; color:#4A4A4A; margin-bottom:6px; }
    .subject-name { font-size:1.4em; font-weight:800; color:#111; margin-bottom:15px; animation:tick 1s infinite ease-in-out; }
    @keyframes tick { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    .progress-circle { position:relative; width:90px; height:90px; margin:0 auto 20px; }
    .progress-circle svg { transform: rotate(-90deg); width:100%; height:100%; }
    .progress-circle circle { fill:none; stroke-width:8; stroke-linecap:round; stroke:#e5e7eb; }
    .progress-circle #progressCircle { stroke:#6366f1; stroke-dasharray:219.911; stroke-dashoffset:219.911; transition:stroke-dashoffset 0.5s ease; }
    .progress-circle span { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-weight:700; color:#6366f1; }
    #markDoneBtn { background:#6366f1; color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; transition:0.2s; }
    #markDoneBtn:hover { background:#4f46e5; }

    /* Task list */
    #taskList { list-style:none; padding:0; margin-top:10px; }
    #taskList li { background:#f3f4f6; padding:10px 14px; border-radius:12px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; font-weight:600; animation:fadeIn 0.6s ease; }
    #taskList li.completed { background:#d1fae5; text-decoration:line-through; color:#16a34a; }
    #taskList button { border:none; background:#6366f1; color:#fff; border-radius:8px; padding:4px 8px; cursor:pointer; transition:0.2s; }
    #taskList button:hover { background:#4f46e5; }

    @keyframes fadeIn { 0% {opacity:0; transform:translateY(-10px);} 100% {opacity:1; transform:translateY(0);} }
  </style>
</head>
<body>
  <button id="logoutBtn">Logout</button>
  <div class="user-bar">
    <img id="userImg" class="user-img" src="" alt="Profile">
    <div class="user-info" id="userInfo"></div>
    <span id="userIdCopy" class="user-id-copy" title="Click to copy User ID"></span>
  </div>

  <div style="padding:32px; text-align:center;">
    <h2>Welcome to your dashboard!</h2>
    <p>Click your profile image to edit your info.</p>
  </div>

  <!-- Subject Widget -->
  <div class="subject-widget">
    <div class="subject-header">Subject of the Day</div>
    <div class="subject-name" id="subjectName">Mathematics</div>
    <div class="progress-circle">
      <svg>
        <circle cx="40" cy="40" r="35"></circle>
        <circle id="progressCircle" cx="40" cy="40" r="35"></circle>
      </svg>
      <span id="percentText">0%</span>
    </div>
    <button id="markDoneBtn">Mark as Completed âœ”</button>
  </div>

  <!-- Task Input -->
  <div class="subject-widget" style="margin-bottom:20px;">
    <div class="subject-header">Add Task</div>
    <input type="text" id="taskInput" placeholder="Enter task name" style="width:60%;padding:8px;border-radius:8px;border:1px solid #6366f1;">
    <select id="taskInterval" style="padding:8px;border-radius:8px;border:1px solid #6366f1;margin-left:5px;">
      <option value="1">Every 1 min</option>
      <option value="5">Every 5 min</option>
      <option value="10">Every 10 min</option>
      <option value="60">Every 1 hour</option>
    </select>
    <button id="addTaskBtn" style="padding:8px 12px;margin-left:5px;border:none;border-radius:8px;background:#6366f1;color:#fff;cursor:pointer;">Add Task</button>
  </div>

  <ul id="taskList"></ul>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC9rehsf-0jkb9dAeT1-0Z1C-yRJ0YI9dA",
      authDomain: "gymnm-ce84b.firebaseapp.com",
      projectId: "gymnm-ce84b",
      storageBucket: "gymnm-ce84b.appspot.com",
      messagingSenderId: "474926929394",
      appId: "1:474926929394:web:6abdb807caba2751a5c76b",
      measurementId: "G-6R9S8LYZNF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Elements
    const userImg = document.getElementById('userImg');
    const userInfo = document.getElementById('userInfo');
    const userIdCopy = document.getElementById('userIdCopy');
    const subjectNameEl = document.getElementById('subjectName');
    const progressCircle = document.getElementById('progressCircle');
    const percentText = document.getElementById('percentText');
    const markDoneBtn = document.getElementById('markDoneBtn');
    const taskInput = document.getElementById('taskInput');
    const taskInterval = document.getElementById('taskInterval');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const taskListEl = document.getElementById('taskList');
    const logoutBtn = document.getElementById('logoutBtn');

    // Current user from URL
    let currentUser = new URLSearchParams(window.location.search).get('user');
    if (!currentUser) { alert("No user specified."); window.location.href="index.html"; }

    let tasks = JSON.parse(localStorage.getItem('tasks_' + currentUser) || "[]");
    let completed = localStorage.getItem('subject_completed') === 'true';

    // Subject widget
    function updateProgress() {
      let percent = completed ? 100 : 0;
      percentText.textContent = percent + "%";
      let dashoffset = 219.911 - (219.911 * percent / 100);
      progressCircle.style.strokeDashoffset = dashoffset;
    }
    markDoneBtn.onclick = () => { completed = true; localStorage.setItem('subject_completed','true'); updateProgress(); };
    updateProgress();

    // Tasks rendering
    function renderTasks() {
      taskListEl.innerHTML = "";
      tasks.forEach((t, i) => {
        const li = document.createElement('li');
        li.textContent = t.name;
        if(t.completed) li.classList.add('completed');
        const btn = document.createElement('button');
        btn.textContent = t.completed ? 'Undo' : 'Done';
        btn.onclick = () => { tasks[i].completed = !tasks[i].completed; localStorage.setItem('tasks_' + currentUser, JSON.stringify(tasks)); renderTasks(); };
        li.appendChild(btn);
        taskListEl.appendChild(li);
      });
    }
    renderTasks();

    // Add task
    addTaskBtn.onclick = () => {
      const name = taskInput.value.trim();
      const interval = parseInt(taskInterval.value);
      if (!name) return;
      tasks.push({name, interval, completed:false});
      localStorage.setItem('tasks_' + currentUser, JSON.stringify(tasks));
      renderTasks();
      taskInput.value = "";
    };

    // Notifications
    function notifyTask(task) {
      if (Notification.permission === "granted") {
        navigator.serviceWorker.getRegistration().then(reg => {
          if(reg) reg.showNotification("ZenStudy Reminder", {
            body: `Task "${task.name}" is pending!`,
            icon: '/Picsart_25-11-28_15-47-25-082.png',
            badge: '/Picsart_25-11-28_15-47-16-095.png',
            data: { url: '/jeeee.html' }
          });
        });
      }
    }

    // Interval checking
    function startTaskNotifications() {
      tasks.forEach((t) => {
        setInterval(() => { if(!t.completed) notifyTask(t); }, t.interval*60*1000);
      });
    }

    // Request permission
    if (Notification.permission !== "granted") Notification.requestPermission().then(p => { if(p==="granted") startTaskNotifications(); });
    else startTaskNotifications();

    // Logout
    logoutBtn.onclick = () => { localStorage.clear(); window.location.href="index.html"; };
  </script>
</body>
</html>
