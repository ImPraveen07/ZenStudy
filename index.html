<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study App Auth</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
   <style>
    /* --- YOUR ORIGINAL STYLES (UNCHANGED) --- */
    html, body {
      height: 100%; margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; background: #e0e7ff; overflow: hidden;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      min-height: 100vh; min-width: 100vw; background: radial-gradient(ellipse at 50% 30%, #e0e7ff 60%, #c7d2fe 100%); display: flex; align-items: center; justify-content: center; transition: background 0.5s;
    }
    #modeSwitchBtn {
      position: fixed; top: 22px; right: 28px; z-index: 1002; background: #fff; border-radius: 50%; box-shadow: 0 2px 16px #6366f133, 0 0 0 2px #6366f1; width: 54px; height: 54px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; user-select: none;
    }
    #modeSwitchBtn:hover { background: #6366f1; }
    #modeSwitchIcon { pointer-events: none; }
    #modeWave {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 2000; opacity: 0; transition: opacity 0.3s; will-change: opacity;
    }
    #modeWave svg {
      width: 100vw; height: 100vh; display: block; position: absolute; left: 0; top: 0; pointer-events: none;
    }
    body {
      --main-bg: #e0e7ff; --main-bg2: #c7d2fe; --floor-bg: #b4b8d6; --floor-bg2: #e0e7ff; --shadow: #6366f155; --box-bg: #e0e7ff; --box-shadow1: #b6b9d6; --box-shadow2: #fff; --box-shadow3: #fff4; --box-shadow4: #dbeafe; --logo-bg: #e0e7ff; --logo-border: #dbeafe; --logo-shadow1: #6366f1; --logo-shadow2: #818cf8cc; --logo-shadow3: #b6b9d6; --logo-shadow4: #fff; --logo-shadow5: #fff4; --title: #3730a3; --title-shadow1: #b6b9d6; --title-shadow2: #fff8; --input-bg: #e0e7ff; --input-color: #222; --input-shadow1: #b6b9d6; --input-shadow2: #fff; --input-shadow3: #fff4; --input-focus-bg: #f1f5f9; --input-focus-shadow1: #b6b9d6; --input-focus-shadow2: #fff; --input-focus-shadow3: #6366f122; --btn-bg: linear-gradient(90deg, #6366f1 10%, #818cf8 90%); --btn-color: #fff; --btn-shadow1: #b6b9d6; --btn-shadow2: #fff; --msg: #3730a3; --msg-shadow: #b6b9d6; --switch-link: #6366f1; --profile-border: #dbeafe; --profile-bg: #f3f4f6; --profile-shadow1: #b6b9d6; --profile-shadow2: #fff; --popup-bg: #fff; --popup-shadow: #3730a355; --popup-close-bg: #fff; --popup-close-shadow: #6366f122; --popup-close-hover-bg: #6366f1; --popup-close-path: #6366f1; --popup-close-hover-path: #fff; --click-here: #6366f1; --click-here-bg: none; --click-here-weight: 700; --click-here-size: 1em; --click-here-cursor: default; --click-here-padding: 0 8px 0 0;
    }
    body.dark-mode {
      background: linear-gradient(120deg, #181c2f 60%, #23243a 100%), url('https://www.transparenttextures.com/patterns/diamond-upholstery.png'); --main-bg: #1a1d2b; --main-bg2: #23243a; --floor-bg: #23243a; --floor-bg2: #181c2f; --shadow: #23243aee; --box-bg: #202233; --box-shadow1: 12px 12px 32px #151624cc, -12px -12px 32px #23243a99, 0 1.5px 0 #2d2e4a inset, 0 0 0 2px #2d2e4a; --box-shadow2: 0 0 0 0 transparent; --box-shadow3: 0 1.5px 0 #23243a inset; --box-shadow4: 0 0 0 2px #6366f1; --logo-bg: #23243a; --logo-border: #6366f1; --logo-shadow1: #6366f1; --logo-shadow2: #818cf8cc; --logo-shadow3: #181c2f; --logo-shadow4: #23243a; --logo-shadow5: #23243a; --title: #c7d2fe; --title-shadow1: #6366f1; --title-shadow2: #23243a; --input-bg: #23243a; --input-color: #e0e7ff; --input-shadow1: 6px 6px 16px #181c2f, -6px -6px 16px #23243a; --input-shadow2: 0 1.5px 0 #6366f1 inset; --input-shadow3: 0 0 0 2px #6366f1; --input-focus-bg: #1a1d2b; --input-focus-shadow1: 0 0 0 2px #818cf8; --input-focus-shadow2: 0 0 0 4px #6366f122; --input-focus-shadow3: 0 0 0 2px #6366f1; --btn-bg: linear-gradient(90deg, #6366f1 10%, #818cf8 90%); --btn-color: #fff; --btn-shadow1: 6px 6px 16px #181c2f, -6px -6px 16px #23243a; --btn-shadow2: 0 0 0 2px #6366f1; --msg: #a5b4fc; --msg-shadow: #6366f1; --switch-link: #a5b4fc; --profile-border: #6366f1; --profile-bg: #23243a; --profile-shadow1: 2px 2px 8px #181c2f; --profile-shadow2: -2px -2px 8px #23243a; --popup-bg: rgba(32,34,51,0.95); --popup-shadow: 0 8px 40px #181c2f99, 0 0 0 2px #6366f1; --popup-close-bg: #181c2f; --popup-close-shadow: 0 2px 8px #6366f1; --popup-close-hover-bg: #6366f1; --popup-close-path: #a5b4fc; --popup-close-hover-path: #fff; --click-here: #a5b4fc; --click-here-bg: none; --click-here-weight: 700; --click-here-size: 1em; --click-here-cursor: default; --click-here-padding: 0 8px 0 0;
    }
    
    /* --- CORRECTED CSS FOR ICON ANIMATION --- */
    #modeSwitchIcon .sun-and-moon {
        transform-origin: center center;
        transition: transform 0.6s cubic-bezier(0.6, 0, 0.3, 1);
    }
    #modeSwitchIcon .moon {
        fill: #6366f1;
        transform-origin: center center;
        transition: opacity 0.6s, transform 0.6s cubic-bezier(0.6, 0, 0.3, 1);
        opacity: 0;
        transform: scale(0.6);
    }
    #modeSwitchIcon .sun-rays {
        stroke: #6366f1;
        stroke-width: 2.5;
        stroke-linecap: round;
        transform-origin: center center;
        transition: transform 0.6s cubic-bezier(0.6, 0, 0.3, 1), opacity 0.6s;
    }
    #modeSwitchBtn:hover #modeSwitchIcon .sun-rays { stroke: #fff; }
    #modeSwitchBtn:hover #modeSwitchIcon .moon { fill: #fff; }
    body.dark-mode #modeSwitchIcon .sun-and-moon { transform: rotate(360deg); }
    body.dark-mode #modeSwitchIcon .moon { opacity: 1; transform: scale(1); }
    body.dark-mode #modeSwitchIcon .sun-rays { transform: scale(0); opacity: 0; }

    .login-3d-box.signup-complete { background: #b4b8d6 !important; transition: background 0.3s; }
    body.dark-mode .login-3d-box { background: var(--box-bg); border-radius: 32px; box-shadow: 0 2px 24px 0 #181c2f, 0 8px 48px 0 #23243a99, 0 0 0 2px #6366f1; border: none; transition: box-shadow 0.3s, background 0.5s; }
    body.dark-mode .login-3d-fields input[type="text"], body.dark-mode .login-3d-fields input[type="password"], body.dark-mode .login-3d-fields input[type="date"], body.dark-mode .login-3d-fields input[type="email"] { background: var(--input-bg); color: var(--input-color); box-shadow: 0 2px 8px #181c2f, 0 1.5px 0 #6366f1 inset; border-radius: 14px; border: none; transition: box-shadow 0.2s, background 0.2s, color 0.5s; }
    body.dark-mode .login-3d-btn { box-shadow: 6px 6px 16px #181c2f, -6px -6px 16px #23243a, 0 0 0 2px #6366f1; border-radius: 16px; background: var(--btn-bg); color: var(--btn-color); transition: box-shadow 0.2s, background 0.5s, color 0.5s; }
    body.dark-mode .popup-content { background: var(--popup-bg); box-shadow: 0 8px 40px #181c2f99, 0 0 0 2px #6366f1; backdrop-filter: blur(8px) saturate(1.2); border-radius: 32px; }
    body.dark-mode::before { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.13; background: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png'); mix-blend-mode: soft-light; }
    body.dark-mode .room-floor { box-shadow: 0 -8px 32px #23243aee inset; background: linear-gradient(0deg, #23243a 0%, #181c2f 100%); }
    body.dark-mode .room-shadow { background: radial-gradient(ellipse at center, #6366f1cc 0%, #0000 80%); filter: blur(8px); opacity: 0.5; }
    .login-3d-container { perspective: 1600px; width: 100vw; transform: translateY(-1vh); height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 3; position: relative; }
    .login-3d-box { background: var(--box-bg); border-radius: 32px; box-shadow: 8px 8px 24px var(--box-shadow1), -8px -8px 24px var(--box-shadow2), 0 1.5px 0 var(--box-shadow3) inset, 0 0 0 1.5px var(--box-shadow4); border: none; padding: 38px 24px 28px 24px; min-width: 320px; max-width: 92vw; width: 350px; display: flex; flex-direction: column; align-items: center; transform-style: preserve-3d; animation: pop3d 1.1s cubic-bezier(.68,-0.55,.27,1.55); position: relative; transition: box-shadow 0.3s, transform 0.2s, background 0.5s; will-change: transform; z-index: 10; overflow: visible; }
    @keyframes pop3d { 0% { transform: rotateY(30deg) scale(0.7) translateY(60px); opacity: 0; } 80% { transform: rotateY(-8deg) scale(1.05) translateY(-8px); opacity: 1; } 100% { transform: rotateY(0deg) scale(1) translateY(0); opacity: 1; } }
    .logo-row { display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 18px; gap: 12px; }
    .login-3d-title { font-size: 1.25em; font-weight: 800; color: var(--title); letter-spacing: .04em; margin-bottom: 18px; text-shadow: 0 2px 4px var(--title-shadow1), 0 1px 0 var(--title-shadow2); text-align: center; z-index: 2; position: relative; transition: color 0.5s, text-shadow 0.5s; }
    .login-3d-fields { width: 100%; display: flex; flex-direction: column; gap: 14px; margin-bottom: 18px; align-items: center; }
    .login-3d-fields input[type="text"], .login-3d-fields input[type="password"], .login-3d-fields input[type="date"], .login-3d-fields input[type="email"] { width: 100%; min-width: 0; max-width: 100%; box-sizing: border-box; padding: 13px 16px; border-radius: 12px; border: none; font-size: 1.08em; background: var(--input-bg); color: var(--input-color); outline: none; box-shadow: 4px 4px 12px var(--input-shadow1), -4px -4px 12px var(--input-shadow2), 0 1.5px 0 var(--input-shadow3) inset; font-family: inherit; font-weight: 500; transition: box-shadow .2s, background .2s, color 0.5s; display: block; }
    .login-3d-fields input:focus { background: var(--input-focus-bg); box-shadow: 2px 2px 6px var(--input-focus-shadow1), -2px -2px 6px var(--input-focus-shadow2), 0 2px 8px var(--input-focus-shadow3); }
    .profile-img-preview { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin: 8px auto 0 auto; display: block; border: 2px solid var(--profile-border); background: var(--profile-bg); box-shadow: 2px 2px 8px var(--profile-shadow1), -2px -2px 8px var(--profile-shadow2); transition: border 0.5s, background 0.5s; }
    .login-3d-btn { margin-top: 8px; width: 100%; min-width: 0; max-width: 100%; box-sizing: border-box; background: var(--btn-bg); color: var(--btn-color); border: none; border-radius: 14px; padding: 13px 0; font-size: 1.12em; font-weight: 700; box-shadow: 4px 4px 12px var(--btn-shadow1), -4px -4px 12px var(--btn-shadow2); cursor: pointer; opacity: 0.96; letter-spacing: .04em; transition: opacity .2s, box-shadow .2s, transform .1s, background 0.5s, color 0.5s; display: block; }
    .login-3d-btn:active { opacity: 1; box-shadow: 2px 2px 6px var(--btn-shadow1), -2px -2px 6px var(--btn-shadow2); transform: scale(0.98); }
    .login-3d-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .login-3d-msg { min-height: 20px; text-align: center; color: var(--msg); font-weight: 600; margin-top: 10px; text-shadow: 0 2px 8px var(--msg-shadow); letter-spacing: .02em; font-size: 1em; transition: color 0.2s; }
    .switch-link { margin-top: 14px; font-size: 0.98em; color: var(--switch-link); text-align: center; cursor: pointer; text-decoration: underline; transition: color 0.5s; }
    .hide { display: none !important; }
    .input-error { box-shadow: 0 0 0 2px #dc2626, 4px 4px 12px var(--box-shadow1), -4px -4px 12px var(--box-shadow2), 0 1.5px 0 var(--box-shadow3) inset !important; background: #fee2e2 !important; animation: shake 0.18s 2; }
    @keyframes shake { 0% { transform: translateX(0);} 25% { transform: translateX(-4px);} 50% { transform: translateX(4px);} 75% { transform: translateX(-4px);} 100% { transform: translateX(0);} }
    .profile-popup { position: fixed; inset: 0; background: rgba(30, 41, 59, 0.18); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.35s; }
    .profile-popup.open { opacity: 1; pointer-events: auto; }
    .popup-content { position: relative; background: var(--popup-bg); border-radius: 999px; box-shadow: 0 8px 40px var(--popup-shadow); width: 92vw; max-width: 420px; height: 70vh; max-height: 520px; display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; opacity: 0; transform: scale(0.3); transition: opacity 0.45s cubic-bezier(.68,-0.55,.27,1.55), transform 0.45s cubic-bezier(.68,-0.55,.27,1.55), transform-origin 0s; will-change: opacity, transform; }
    .profile-popup.open .popup-content { opacity: 1; transform: scale(1); }
    .popup-title { font-size: 1.4em; font-weight: 800; color: var(--title); text-align: center; margin: 30px 0 18px 0; letter-spacing: .05em; text-shadow: 0 2px 4px var(--title-shadow1); transition: color 0.5s, text-shadow 0.5s; }
    .popup-list { list-style: none; padding: 0 40px; margin: 0; overflow-y: auto; flex-grow: 1; font-weight: 600; font-size: 1.05em; color: var(--input-color); line-height: 1.6; }
    .popup-close { position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; background: var(--popup-close-bg); border-radius: 50%; box-shadow: 0 0 16px var(--popup-close-shadow); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; }
    .popup-close:hover { background: var(--popup-close-hover-bg); }
    .popup-close path { stroke: var(--popup-close-path); transition: stroke 0.2s; }
    .popup-close:hover path { stroke: var(--popup-close-hover-path); }
    .popup-list li { margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
    body.dark-mode .popup-list { color: var(--input-color); }
    body.dark-mode .popup-list li { border-bottom: 1px solid #2d2e4a; }
    .gyro-switch { background: var(--input-bg); padding: 10px 18px; border-radius: 12px; margin: 0 40px 20px 40px; font-size: 0.9em; display: flex; align-items: center; justify-content: space-between; box-shadow: 4px 4px 12px var(--input-shadow1), -4px -4px 12px var(--input-shadow2), 0 1.5px 0 var(--input-shadow3) inset; }
    .switch { position: relative; display: inline-block; width: 48px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #6366f1; }
    input:checked + .slider:before { transform: translateX(20px); }
    .form-separator { text-align: center; margin: 10px 0; font-size: 0.9em; font-weight: 500; color: var(--msg); opacity: 0.8; letter-spacing: 0.01em; font-family: 'Inter', Arial, sans-serif; }
    .dob-field-wrap, .pass-field-wrap { width: 100%; }
    #google-auth-container { width: 100%; margin-top: 10px; }
    .google-account-button { width: 100%; box-sizing: border-box; background: #fff; color: #222; border: 1px solid var(--btn-shadow1); border-radius: 14px; padding: 8px 12px; box-shadow: 4px 4px 12px var(--btn-shadow1), -4px -4px 12px var(--btn-shadow2); cursor: pointer; transition: opacity .2s, box-shadow .2s, transform .1s, background 0.5s, color 0.5s; display: flex; align-items: center; gap: 12px; }
    .google-account-button:active { opacity: 1; box-shadow: 2px 2px 6px var(--btn-shadow1), -2px -2px 6px var(--btn-shadow2); transform: scale(0.98); }
    .google-account-button img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--profile-border); }
    .google-account-button .user-details { text-align: left; line-height: 1.3; }
    .google-account-button .user-name { font-weight: 700; font-size: 1.05em; color: var(--title); }
    .google-account-button .user-email { font-size: 0.9em; color: var(--switch-link); }
    body.dark-mode .google-account-button { background: var(--input-bg); border-color: #6366f1; box-shadow: 6px 6px 16px #181c2f, -6px -6px 16px #23243a, 0 0 0 2px #6366f1; }
    /* --- NEW CSS FOR OFFLINE INDICATOR --- */
    #offline-indicator { position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .offline-content { background: var(--box-bg); border-radius: 32px; padding: 30px; box-shadow: 0 8px 40px #181c2f99, 0 0 0 2px #6366f1; width: 320px; max-width: 90vw; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .offline-scene { width: 120px; height: 120px; position: relative; margin: 20px 0 10px 0; transform: scale(0.9); }
    .offline-phone { width: 60px; height: 100px; background: #fff; border: 3px solid #3730a3; border-radius: 8px; position: absolute; top: 10px; left: 10px; box-shadow: 0 0 0 3px #6366f1; transform-origin: center; animation: phoneShake 2s infinite ease-in-out; }
    .offline-phone:before { content: ""; position: absolute; top: 6px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #3730a3; border-radius: 50%; }
    .offline-phone:after { content: ""; position: absolute; top: 14px; left: 50%; transform: translateX(-50%); width: 80%; height: 70px; background: #e0e7ff; border-radius: 4px; }
    .internet-wire { position: absolute; top: 50px; left: 70px; width: 60px; height: 2px; background: #3730a3; transform: rotate(-45deg); transform-origin: left center; animation: wireStretch 2s infinite ease-in-out; }
    .wire-plug { width: 10px; height: 10px; background: #dc2626; border-radius: 2px; position: absolute; right: -5px; top: -4px; animation: plugWiggle 2s infinite ease-in-out; }
    @keyframes phoneShake { 0% { transform: translateY(0) rotate(0deg); } 20% { transform: translateY(-5px) rotate(3deg); } 40% { transform: translateY(5px) rotate(-3deg); } 60% { transform: translateY(-3px) rotate(2deg); } 80% { transform: translateY(3px) rotate(-2deg); } 100% { transform: translateY(0) rotate(0deg); } }
    @keyframes wireStretch { 0% { transform: rotate(-45deg) scaleX(1); } 50% { transform: rotate(-45deg) scaleX(0.8); } 100% { transform: rotate(-45deg) scaleX(1); } }
    @keyframes plugWiggle { 0% { transform: translateX(0) rotate(0deg); } 10% { transform: translateX(120px) rotate(0deg); } 20% { transform: translateX(115px) rotate(0deg); } 30% { transform: translateX(120px) rotate(0deg); } 40% { transform: translateX(0) rotate(15deg); } 50% { transform: translateX(0) rotate(0deg); } 60% { transform: translateX(120px) rotate(0deg); } 70% { transform: translateX(115px) rotate(0deg); } 80% { transform: translateX(120px) rotate(0deg); } 90% { transform: translateX(0) rotate(15deg); } }
    .offline-message { margin-top: 20px; font-size: 1.2em; font-weight: 700; color: var(--title); text-shadow: 0 1px 2px var(--title-shadow2); background: var(--box-bg); padding: 8px 16px; border-radius: 12px; box-shadow: var(--box-shadow1); }
  </style>
</head>
<body>
<div class="room-floor"></div>
<div class="room-shadow"></div>
<div id="modeSwitchBtn" title="Switch UI Mode">
    <svg id="modeSwitchIcon" width="32" height="32" viewBox="0 0 32 32" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <g class="sun-and-moon">
            <mask id="moon-mask">
                <rect x="0" y="0" width="100%" height="100%" fill="white" />
                <circle cx="24" cy="10" r="8" fill="black" />
            </mask>
            <circle class="moon" cx="16" cy="16" r="8" fill="#6366f1" mask="url(#moon-mask)"></circle>
            <g class="sun-rays">
                <line x1="16" y1="3" x2="16" y2="7"></line>
                <line x1="16" y1="25" x2="16" y2="29"></line>
                <line x1="6.86" y1="6.86" x2="9.69" y2="9.69"></line>
                <line x1="22.31" y1="22.31" x2="25.14" y2="25.14"></line>
                <line x1="3" y1="16" x2="7" y2="16"></line>
                <line x1="25" y1="16" x2="29" y2="16"></line>
                <line x1="6.86" y1="25.14" x2="9.69" y2="22.31"></line>
                <line x1="22.31" y1="9.69" x2="25.14" y2="6.86"></line>
            </g>
        </g>
    </svg>
</div>
<div id="modeWave"></div>

<div class="login-3d-container">
    
    <div id="signupCard" class="login-3d-box">
        <div class="logo-row">
            <img src="https://cdn-icons-png.flaticon.com/512/295/295128.png" alt="Logo" class="login-3d-logo" title="About App">
        </div>
        <div class="login-3d-title">Create Account</div>
        <div class="login-3d-fields">
            <input type="text" id="signupUsername" placeholder="Enter Username" autocomplete="nickname">
            <input type="email" id="signupEmail" placeholder="Enter Email" autocomplete="email">
            <div class="pass-field-wrap">
                <input type="password" id="signupPass" placeholder="Enter Password" autocomplete="new-password">
            </div>
            <div class="dob-field-wrap">
                <input type="date" id="signupDOB" placeholder="Date of Birth" max="2010-01-01">
            </div>
        </div>
        
        <button id="signupBtn" class="login-3d-btn" disabled>Sign Up</button>
        <div id="signupMsg" class="login-3d-msg">Please fill all fields.</div>
        
        <div class="form-separator">OR</div>
        
        <div id="google-auth-container">
            <div id="googleConnectBtn" class="google-account-button">
                <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" alt="Google">
                <span class="user-details"><span class="user-name">Connect Google</span><span class="user-email">Optional: for easy sign-in</span></span>
            </div>
            
            <div id="googleAccountInfo" class="google-account-button hide">
                <img id="googleUserPic" src="" alt="Google Profile">
                <span class="user-details"><span id="googleUserName" class="user-name"></span><span id="googleUserEmail" class="user-email"></span></span>
            </div>
        </div>
        
        <div id="toLoginBtn" class="switch-link">Already have an account? Login here.</div>
    </div>
    
    <div id="loginCard" class="login-3d-box hide">
        <div class="logo-row">
            <img src="https://cdn-icons-png.flaticon.com/512/295/295128.png" alt="Logo" class="login-3d-logo" title="About App">
        </div>
        <div class="login-3d-title">Account Login</div>
        <div class="login-3d-fields">
            <input type="text" id="loginUserId" placeholder="Enter User ID" autocomplete="username">
            <div class="pass-field-wrap">
                <input type="password" id="loginPass" placeholder="Enter Password" autocomplete="current-password">
            </div>
        </div>
        
        <button id="loginBtn" class="login-3d-btn" disabled>Login</button>
        <div id="loginMsg" class="login-3d-msg"></div>
        
        <div class="form-separator">OR</div>
        
        <div id="google-auth-container">
            <button id="googleLoginBtnLogin" class="google-account-button">
                <img src="https://cdn-icons-png.flaticon.com/512/300/300221.png" alt="Google">
                <span class="user-details"><span class="user-name">Sign In with Google</span><span class="user-email">Use your connected account</span></span>
            </button>
        </div>
        
        <div id="toSignupBtn" class="switch-link">Need an account? Sign Up here.</div>
    </div>
    
</div>

<div id="profilePopup" class="profile-popup">
    <div class="popup-content">
        <div class="popup-title">App Info</div>
        <ul class="popup-list">
            <li>Securely store your data.</li>
            <li>Use two-factor authentication (coming soon).</li>
            <li>This app is a study project.</li>
        </ul>
        <div class="popup-close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </div>
    </div>
</div>

<div id="offline-indicator" style="display: none;">
    <div class="offline-content">
        <div class="offline-scene">
            <div class="offline-phone"></div>
            <div class="internet-wire">
                <div class="wire-plug"></div>
            </div>
        </div>
        <div class="offline-message">Offline. Check connection.</div>
    </div>
</div>

<script>
/** * ==========================================
 * INITIAL REDIRECT LOGIC - Use last_logged_in_user and look up in storage
 * ==========================================
 */
const lastUser = localStorage.getItem("last_logged_in_user");
if (lastUser) {
    // Check if user data exists locally for the last logged-in user (which is the CUSTOM User ID)
    const userData = localStorage.getItem("user_" + lastUser);
    if (userData) {
        // Redirect to main page using the stored CUSTOM User ID
        window.location.replace(`main.html?user=${encodeURIComponent(lastUser)}`);
    }
}


/** * ==========================================
 * 1. FIREBASE CONFIGURATION & INITIALIZATION
 * ==========================================
 */
const firebaseConfig = { apiKey: "AIzaSyC9rehsf-0jkb9dAeT1-0Z1C-yRJ0YI9dA", authDomain: "gymnm-ce84b.firebaseapp.com", projectId: "gymnm-ce84b", storageBucket: "gymnm-ce84b.appspot.com", messagingSenderId: "474926929394", appId: "1:474926929394:web:6abdb807caba2751a5c76b", measurementId: "G-6R9S8LYZNF" };
// Initialize Firebase only if not already initialized
if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
const db = firebase.firestore();
const auth = firebase.auth(); 
// ... (Theme, Visuals, Gyro, Offline Indicator logic - kept for completeness)
// ...

/** * ==========================================
 * 2. UTILITY FUNCTIONS (Custom Logic)
 * ==========================================
 */

// **NEW:** Function to generate custom User ID (username + dob + 2 random digits)
function generateCustomUserId(username, dob) {
    const cleanUsername = username.toLowerCase().replace(/[^a-z0-9]/g, '').slice(0, 8); // Max 8 chars
    const d = new Date(dob);
    // Format DOB to DDMMYY
    const dobStr = `${d.getDate().toString().padStart(2, '0')}${(d.getMonth() + 1).toString().padStart(2, '0')}${d.getFullYear().toString().slice(-2)}`;
    const randomNum = Math.floor(10 + Math.random() * 90); // 2 random numbers (10-99)
    return `${cleanUsername}${dobStr}${randomNum}`;
}

// ... (Other utility functions - kept for completeness)
// ...

/** * ==========================================
 * 6. UI ELEMENTS & EVENT HANDLERS
 * ==========================================
 */
const signupCard = document.getElementById('signupCard');
const loginCard = document.getElementById('loginCard');
const toLoginBtn = document.getElementById('toLoginBtn');
const toSignupBtn = document.getElementById('toSignupBtn');
const popupClose = document.querySelector('.popup-close');
const logoBtn = document.querySelector('.login-3d-logo');
const profilePopup = document.getElementById('profilePopup');

// --- Signup Elements (New IDs/Focus) --- 
const signupUsername = document.getElementById('signupUsername'); // NEW ID
const signupEmail = document.getElementById('signupEmail');      
const signupPass = document.getElementById('signupPass');
const signupDOB = document.getElementById('signupDOB');
const signupBtn = document.getElementById('signupBtn');
const signupMsg = document.getElementById('signupMsg');
const googleConnectBtn = document.getElementById('googleConnectBtn');
const googleAccountInfo = document.getElementById('googleAccountInfo');
const googleUserPic = document.getElementById('googleUserPic');
const googleUserName = document.getElementById('googleUserName');
const googleUserEmail = document.getElementById('googleUserEmail');

// --- Login Elements (New IDs/Focus) --- 
const loginUserId = document.getElementById('loginUserId'); // NEW ID
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const googleLoginBtnLogin = document.getElementById('googleLoginBtnLogin');

// --- State --- 
let googleUser = null; 
let isGoogleSigningIn = false;

// Card Switch Logic 
if (toLoginBtn) {
    toLoginBtn.onclick = () => {
        loginMsg.textContent = "";
        signupCard.classList.add('hide');
        loginCard.classList.remove('hide');
        checkLoginFields();
        // Clear any previous errors on switch
        loginUserId.classList.remove('input-error');
        loginPass.classList.remove('input-error');
    };
}
if (toSignupBtn) {
    toSignupBtn.onclick = () => {
        signupMsg.textContent = "Please fill all fields.";
        loginCard.classList.add('hide');
        signupCard.classList.remove('hide');
        checkSignupFields();
        // Clear any previous errors on switch
        signupUsername.classList.remove('input-error');
        signupEmail.classList.remove('input-error');
        signupPass.classList.remove('input-error');
    };
}

function checkSignupFields() {
    const isUsernameValid = signupUsername.value.length > 2; // NEW CHECK
    const isEmailValid = signupEmail.value.includes('@') && signupEmail.value.length > 5;
    const isPasswordValid = signupPass.value.length >= 6;
    const isDOBValid = signupDOB.value !== "";
    
    if (isUsernameValid && isEmailValid && isPasswordValid && isDOBValid) {
        signupBtn.disabled = false;
        signupMsg.textContent = "Ready to Sign Up!";
    } else {
        signupBtn.disabled = true;
        if (!isUsernameValid) signupMsg.textContent = "Enter a valid Username (3+ chars).";
        else if (!isEmailValid) signupMsg.textContent = "Enter a valid Email.";
        else if (!isPasswordValid) signupMsg.textContent = "Password must be 6+ characters.";
        else if (!isDOBValid) signupMsg.textContent = "Enter Date of Birth.";
    }
}

function checkLoginFields() {
    // User ID is expected to be long (e.g., john12019845)
    const isUserIdValid = loginUserId.value.length > 5; 
    const isPasswordValid = loginPass.value.length >= 6;
    
    if (isUserIdValid && isPasswordValid) {
        loginBtn.disabled = false;
    } else {
        loginBtn.disabled = true;
    }
}

// Attach Listeners to Inputs
if (signupUsername) signupUsername.oninput = () => { checkSignupFields(); signupUsername.classList.remove('input-error'); };
if (signupEmail) signupEmail.oninput = () => { checkSignupFields(); signupEmail.classList.remove('input-error'); };
if (signupPass) signupPass.oninput = () => { checkSignupFields(); signupPass.classList.remove('input-error'); };
if (signupDOB) signupDOB.oninput = () => { checkSignupFields(); signupDOB.classList.remove('input-error'); };

if (loginUserId) loginUserId.oninput = () => { checkLoginFields(); loginUserId.classList.remove('input-error'); };
if (loginPass) loginPass.oninput = () => { checkLoginFields(); loginPass.classList.remove('input-error'); };

// Popup Logic (Kept from original)
if (logoBtn) {
    logoBtn.onclick = () => profilePopup.classList.add('open');
}
if (popupClose) {
    popupClose.onclick = () => profilePopup.classList.remove('open');
}

// --- Google Connect Logic (Signup) ---
async function connectGoogle(promptForAccount = false) {
    // ... (Your original Google Connect logic for Signup goes here, 
    // it connects the Google account but does NOT automatically sign up)
    // For brevity, assuming the function body is from your original file:
    const provider = new firebase.auth.GoogleAuthProvider();
    if (promptForAccount) {
        provider.setCustomParameters({ prompt: 'select_account' });
    }
    
    try {
        const result = await auth.signInWithPopup(provider);
        googleUser = result.user;
        
        googleConnectBtn.classList.add('hide');
        googleAccountInfo.classList.remove('hide');
        googleUserPic.src = googleUser.photoURL || 'https://cdn-icons-png.flaticon.com/512/300/300221.png';
        googleUserName.textContent = googleUser.displayName;
        googleUserEmail.textContent = googleUser.email;
        signupMsg.textContent = "Google connected. Ready to Sign Up!";
        
        // Populate Email field with Google Email if empty
        if (!signupEmail.value) {
            signupEmail.value = googleUser.email;
            checkSignupFields();
        }

    } catch (error) {
        console.error("Google sign-in error:", error);
        googleUser = null;
        googleConnectBtn.classList.remove('hide');
        googleAccountInfo.classList.add('hide');
        signupMsg.textContent = "Google connection failed. Please try again.";
        // Reset state
        checkSignupFields();
    }
}


/** * ==========================================
 * 7. AUTHENTICATION LOGIC (Signup & Login)
 * ==========================================
 */

// --- SIGNUP LOGIC IMPLEMENTATION (MANUAL) ---
if (signupBtn) {
    signupBtn.onclick = async function() {
        if (signupBtn.disabled) return;
        signupBtn.disabled = true;
        signupMsg.textContent = "Creating user account...";

        const username = signupUsername.value.trim();
        const email = signupEmail.value.trim();
        const password = signupPass.value;
        const dob = signupDOB.value;
        
        // 1. Generate CUSTOM User ID
        const customUserId = generateCustomUserId(username, dob);
        
        // 2. Check if custom User ID already exists in Firestore
        const userIdCheck = await db.collection('users').doc(customUserId).get();
        if (userIdCheck.exists) {
            signupMsg.innerHTML = `⚠️ Custom User ID already exists. Try changing username/DOB.`;
            signupBtn.disabled = false;
            return;
        }

        let firebaseUser = null;
        try {
            // 3. Register user with Firebase Auth (required for email login/reset flow)
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            firebaseUser = userCredential.user;
            
            // 4. Create user data object (INSECURE: Storing password for custom login)
            const userData = {
                uid: firebaseUser.uid, // Keep Firebase UID for Auth linkage
                userId: customUserId, // **Custom ID**
                username: username,
                email: email,
                password: password, // ⚠️ INSECURE STORAGE (as requested)
                dob: dob,
                // If Google was connected during signup, link it
                googleEmail: googleUser ? googleUser.email : null,
                googleName: googleUser ? googleUser.displayName : null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // 5. Write to Firestore using the CUSTOM ID as the document key
            await db.collection('users').doc(customUserId).set(userData);

            // 6. Save local session using the CUSTOM ID
            localStorage.setItem("user_" + customUserId, JSON.stringify(userData));
            localStorage.setItem("last_logged_in_user", customUserId);

            signupMsg.innerHTML = `Success! Your User ID is: <b>${customUserId}</b>. Redirecting...`;
            signupCard.classList.add('signup-complete');

            setTimeout(() => {
                window.location.replace(`main.html?user=${encodeURIComponent(customUserId)}`);
            }, 1000);

        } catch (err) {
            console.error(err);
            let errorMessage = "Signup error.";
            if (err.code === 'auth/email-already-in-use') {
                errorMessage = "This email is already in use. Please login.";
                signupEmail.classList.add('input-error');
            } else if (err.code === 'auth/invalid-email') {
                errorMessage = "The email address is not valid.";
                signupEmail.classList.add('input-error');
            } else if (err.code === 'auth/weak-password') {
                errorMessage = "The password is too weak. Must be at least 6 characters.";
                signupPass.classList.add('input-error');
            } else {
                errorMessage = `Error: ${err.message}`;
            }
            signupMsg.textContent = errorMessage;
            signupBtn.disabled = false;
            // If Firebase Auth failed, ensure we sign out the partially created user (if any)
            if (firebaseUser) {
                auth.signOut().catch(e => console.error("Error during partial signout:", e));
            }
        } finally {
            // Re-check fields just in case of non-Firebase errors
            checkSignupFields();
        }
    };
}

// --- LOGIN LOGIC IMPLEMENTATION (MANUAL - Custom User ID) ---
if (loginBtn) {
    loginBtn.onclick = async function() {
        if (loginBtn.disabled) return;
        loginBtn.disabled = true;
        loginMsg.textContent = "Logging in...";

        const userId = loginUserId.value.trim();
        const password = loginPass.value;

        try {
            // 1. Fetch user by CUSTOM User ID
            const userDoc = await db.collection('users').doc(userId).get();

            if (!userDoc.exists) {
                loginMsg.innerHTML = "⚠️ User ID not found.";
                loginUserId.classList.add('input-error');
                loginBtn.disabled = false;
                return;
            }

            const userData = userDoc.data();

            // 2. Validate password manually (INSECURE: Comparing passwords on client-side)
            if (userData.password !== password) {
                loginMsg.innerHTML = "⚠️ Incorrect password.";
                loginPass.classList.add('input-error');
                loginBtn.disabled = false;
                return;
            }
            
            // 3. Optional: Sign in with Firebase Auth using the stored email/password 
            // This is needed to maintain a Firebase Auth session if required by other parts of the app.
            if (userData.email) {
                try {
                    await auth.signInWithEmailAndPassword(userData.email, password);
                } catch (authError) {
                    // Log warning but proceed with custom login
                    console.warn("Firebase Auth sign-in failed (possible reason: user deleted in Auth). Proceeding with Custom Login.", authError);
                }
            }

            // 4. Save local session using the CUSTOM User ID
            localStorage.setItem("user_" + userId, JSON.stringify(userData));
            localStorage.setItem("last_logged_in_user", userId);

            loginMsg.textContent = "Login successful. Redirecting...";

            setTimeout(() => {
                window.location.replace(`main.html?user=${encodeURIComponent(userId)}`);
            }, 500);

        } catch (err) {
            console.error(err);
            loginMsg.textContent = `Login error: ${err.message}`;
        } finally {
            loginBtn.disabled = false;
            // If fields are empty after error, re-disable the button
            checkLoginFields(); 
        }
    };
}


// --- GOOGLE LOGIN LOGIC (Checks Firestore for linked account) ---
if (googleLoginBtnLogin) {
    googleLoginBtnLogin.onclick = async function() {
        if (isGoogleSigningIn) return;
        isGoogleSigningIn = true;
        loginMsg.textContent = "Opening Google Sign-in...";
        googleLoginBtnLogin.disabled = true;
        loginBtn.disabled = true;

        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            const firebaseUser = result.user;
            const uid = firebaseUser.uid;

            // 1. Check for user by their Firebase UID first (primary link)
            let userDoc = null;
            let userQuery = await db.collection('users').where('uid', '==', uid).get(); 

            if (userQuery.empty) {
                // 2. If no UID link, check by Google Email (secondary link)
                userQuery = await db.collection('users').where('email', '==', firebaseUser.email).get();
                if (userQuery.empty) {
                    // 3. No account found via UID or Email
                    await auth.signOut();
                    loginMsg.innerHTML = "⚠️ No full account profile found linked to this Google email. Please sign up first.";
                    googleLoginBtnLogin.disabled = false;
                    loginBtn.disabled = false;
                    return;
                }
            }
            
            // Account found!
            userDoc = userQuery.docs[0];
            const userData = userDoc.data();
            const customUserId = userDoc.id; // The document ID is the custom ID now
            
            // IMPORTANT: If found by email, update the Firestore record to link the new Firebase UID
            if (userData.uid !== uid) {
                 await db.collection('users').doc(customUserId).update({
                    uid: uid,
                    googleEmail: firebaseUser.email,
                    googleName: firebaseUser.displayName,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });
                userData.uid = uid; // Update local copy
            }

            // 4. Save session with CUSTOM User ID
            localStorage.setItem("user_" + customUserId, JSON.stringify(userData));
            localStorage.setItem("last_logged_in_user", customUserId);

            loginMsg.textContent = "Google Login successful. Redirecting...";

            setTimeout(() => {
                window.location.replace(`main.html?user=${encodeURIComponent(customUserId)}`);
            }, 500);

        } catch (err) {
            console.error(err);
            loginMsg.textContent = "Google login error. Please try again or use User ID/password.";
        } finally {
            isGoogleSigningIn = false;
            googleLoginBtnLogin.disabled = false;
            loginBtn.disabled = false;
        }
    };
}
// Clear error state on input - already handled in oninput
</script>
</body>
</html>
