<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study App Auth</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
   <style>
    /* --- YOUR ORIGINAL STYLES (UNCHANGED) --- */
    html, body {
      height: 100%; margin: 0; padding: 0; font-family: 'Inter', Arial, sans-serif; background: #e0e7ff; overflow: hidden;
      -webkit-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      min-height: 100vh; min-width: 100vw; background: radial-gradient(ellipse at 50% 30%, #e0e7ff 60%, #c7d2fe 100%); display: flex; align-items: center; justify-content: center; transition: background 0.5s;
    }
    #modeSwitchBtn {
      position: fixed; top: 22px; right: 28px; z-index: 1002; background: #fff; border-radius: 50%; box-shadow: 0 2px 16px #6366f133, 0 0 0 2px #6366f1; width: 54px; height: 54px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s, box-shadow 0.2s; user-select: none;
    }
    #modeSwitchBtn:hover { background: #6366f1; }
    #modeSwitchIcon { pointer-events: none; }
    #modeWave {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 2000; opacity: 0; transition: opacity 0.3s; will-change: opacity;
    }
    #modeWave svg {
      width: 100vw; height: 100vh; display: block; position: absolute; left: 0; top: 0; pointer-events: none;
    }
    body {
      --main-bg: #e0e7ff; --main-bg2: #c7d2fe; --floor-bg: #b4b8d6; --floor-bg2: #e0e7ff; --shadow: #6366f155; --box-bg: #e0e7ff; --box-shadow1: #b6b9d6; --box-shadow2: #fff; --box-shadow3: #fff4; --box-shadow4: #dbeafe; --logo-bg: #e0e7ff; --logo-border: #dbeafe; --logo-shadow1: #6366f1; --logo-shadow2: #818cf8cc; --logo-shadow3: #b6b9d6; --logo-shadow4: #fff; --logo-shadow5: #fff4; --title: #3730a3; --title-shadow1: #b6b9d6; --title-shadow2: #fff8; --input-bg: #e0e7ff; --input-color: #222; --input-shadow1: #b6b9d6; --input-shadow2: #fff; --input-shadow3: #fff4; --input-focus-bg: #f1f5f9; --input-focus-shadow1: #b6b9d6; --input-focus-shadow2: #fff; --input-focus-shadow3: #6366f122; --btn-bg: linear-gradient(90deg, #6366f1 10%, #818cf8 90%); --btn-color: #fff; --btn-shadow1: #b6b9d6; --btn-shadow2: #fff; --msg: #3730a3; --msg-shadow: #b6b9d6; --switch-link: #6366f1; --profile-border: #dbeafe; --profile-bg: #f3f4f6; --profile-shadow1: #b6b9d6; --profile-shadow2: #fff; --popup-bg: #fff; --popup-shadow: #3730a355; --popup-close-bg: #fff; --popup-close-shadow: #6366f122; --popup-close-hover-bg: #6366f1; --popup-close-path: #6366f1; --popup-close-hover-path: #fff; --click-here: #6366f1; --click-here-bg: none; --click-here-weight: 700; --click-here-size: 1em; --click-here-cursor: default; --click-here-padding: 0 8px 0 0;
    }
    body.dark-mode {
      background: linear-gradient(120deg, #181c2f 60%, #23243a 100%), url('https://www.transparenttextures.com/patterns/diamond-upholstery.png'); --main-bg: #1a1d2b; --main-bg2: #23243a; --floor-bg: #23243a; --floor-bg2: #181c2f; --shadow: #23243aee; --box-bg: #202233; --box-shadow1: 12px 12px 32px #151624cc, -12px -12px 32px #23243a99, 0 1.5px 0 #2d2e4a inset, 0 0 0 2px #2d2e4a; --box-shadow2: 0 0 0 0 transparent; --box-shadow3: 0 1.5px 0 #23243a inset; --box-shadow4: 0 0 0 2px #6366f1; --logo-bg: #23243a; --logo-border: #6366f1; --logo-shadow1: #6366f1; --logo-shadow2: #818cf8cc; --logo-shadow3: #181c2f; --logo-shadow4: #23243a; --logo-shadow5: #23243a; --title: #c7d2fe; --title-shadow1: #6366f1; --title-shadow2: #23243a; --input-bg: #23243a; --input-color: #e0e7ff; --input-shadow1: 6px 6px 16px #181c2f, -6px -6px 16px #23243a; --input-shadow2: 0 1.5px 0 #6366f1 inset; --input-shadow3: 0 0 0 2px #6366f1; --input-focus-bg: #1a1d2b; --input-focus-shadow1: 0 0 0 2px #818cf8; --input-focus-shadow2: 0 0 0 4px #6366f122; --input-focus-shadow3: 0 0 0 2px #6366f1; --btn-bg: linear-gradient(90deg, #6366f1 10%, #818cf8 90%); --btn-color: #fff; --btn-shadow1: 6px 6px 16px #181c2f, -6px -6px 16px #23243a; --btn-shadow2: 0 0 0 2px #6366f1; --msg: #a5b4fc; --msg-shadow: #6366f1; --switch-link: #a5b4fc; --profile-border: #6366f1; --profile-bg: #23243a; --profile-shadow1: 2px 2px 8px #181c2f; --profile-shadow2: -2px -2px 8px #23243a; --popup-bg: rgba(32,34,51,0.95); --popup-shadow: 0 8px 40px #181c2f99, 0 0 0 2px #6366f1; --popup-close-bg: #181c2f; --popup-close-shadow: 0 2px 8px #6366f1; --popup-close-hover-bg: #6366f1; --popup-close-path: #a5b4fc; --popup-close-hover-path: #fff; --click-here: #a5b4fc; --click-here-bg: none; --click-here-weight: 700; --click-here-size: 1em; --click-here-cursor: default; --click-here-padding: 0 8px 0 0;
    }
    
    /* --- CORRECTED CSS FOR ICON ANIMATION --- */
    #modeSwitchIcon .sun-and-moon {
        transform-origin: center center;
        transition: transform 0.6s cubic-bezier(0.6, 0, 0.3, 1);
    }
    #modeSwitchIcon .moon {
        fill: #6366f1;
        transform-origin: center center;
        transition: opacity 0.6s, transform 0.6s cubic-bezier(0.6, 0, 0.3, 1);
        opacity: 0;
        transform: scale(0.6);
    }
    #modeSwitchIcon .sun-rays {
        stroke: #6366f1;
        stroke-width: 2.5;
        stroke-linecap: round;
        transform-origin: center center;
        transition: transform 0.6s cubic-bezier(0.6, 0, 0.3, 1), opacity 0.6s;
    }
    #modeSwitchBtn:hover #modeSwitchIcon .sun-rays { stroke: #fff; }
    #modeSwitchBtn:hover #modeSwitchIcon .moon { fill: #fff; }
    body.dark-mode #modeSwitchIcon .sun-and-moon { transform: rotate(360deg); }
    body.dark-mode #modeSwitchIcon .moon { opacity: 1; transform: scale(1); }
    body.dark-mode #modeSwitchIcon .sun-rays { transform: scale(0); opacity: 0; }

    .login-3d-box.signup-complete { background: #b4b8d6 !important; transition: background 0.3s; }
    body.dark-mode .login-3d-box { background: var(--box-bg); border-radius: 32px; box-shadow: 0 2px 24px 0 #181c2f, 0 8px 48px 0 #23243a99, 0 0 0 2px #6366f1; border: none; transition: box-shadow 0.3s, background 0.5s; }
    body.dark-mode .login-3d-fields input[type="text"], body.dark-mode .login-3d-fields input[type="password"], body.dark-mode .login-3d-fields input[type="date"], body.dark-mode .login-3d-fields input[type="email"] { background: var(--input-bg); color: var(--input-color); box-shadow: 0 2px 8px #181c2f, 0 1.5px 0 #6366f1 inset; border-radius: 14px; border: none; transition: box-shadow 0.2s, background 0.2s, color 0.5s; }
    body.dark-mode .login-3d-btn { box-shadow: 6px 6px 16px #181c2f, -6px -6px 16px #23243a, 0 0 0 2px #6366f1; border-radius: 16px; background: var(--btn-bg); color: var(--btn-color); transition: box-shadow 0.2s, background 0.5s, color 0.5s; }
    body.dark-mode .popup-content { background: var(--popup-bg); box-shadow: 0 8px 40px #181c2f99, 0 0 0 2px #6366f1; backdrop-filter: blur(8px) saturate(1.2); border-radius: 32px; }
    body.dark-mode::before { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 0; opacity: 0.13; background: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png'); mix-blend-mode: soft-light; }
    body.dark-mode .room-floor { box-shadow: 0 -8px 32px #23243aee inset; background: linear-gradient(0deg, #23243a 0%, #181c2f 100%); }
    body.dark-mode .room-shadow { background: radial-gradient(ellipse at center, #6366f1cc 0%, #0000 80%); filter: blur(8px); opacity: 0.5; }
    .login-3d-logo { width: 56px; height: 56px; border-radius: 16px; background: var(--logo-bg); object-fit: cover; border: 2px solid var(--logo-border); display: block; box-shadow: 0 0 0 0 var(--logo-shadow1), 0 0 16px 4px var(--logo-shadow2), 4px 4px 12px var(--logo-shadow3), -4px -4px 12px var(--logo-shadow4), 0 1.5px 0 var(--logo-shadow5) inset; z-index: 2; position: relative; cursor: pointer; transition: box-shadow 0.2s, transform 0.2s, background 0.5s, border 0.5s; animation: logoGlow 1.2s infinite alternate; }
    @keyframes logoGlow { 0% { box-shadow: 0 0 0 0 var(--logo-shadow1), 0 0 16px 4px var(--logo-shadow2), 4px 4px 12px var(--logo-shadow3), -4px -4px 12px var(--logo-shadow4), 0 1.5px 0 var(--logo-shadow5) inset; } 100% { box-shadow: 0 0 0 12px var(--logo-shadow1), 0 0 32px 16px var(--logo-shadow2), 4px 4px 12px var(--logo-shadow3), -4px -4px 12px var(--logo-shadow4), 0 1.5px 0 var(--logo-shadow5) inset; } }
    body.dark-mode .login-3d-logo { box-shadow: 0 0 0 0 #6366f1, 0 0 32px 8px #6366f1cc, 0 0 64px 24px #818cf8cc, 4px 4px 16px #181c2f, -4px -4px 16px #23243a, 0 1.5px 0 #23243a inset; animation: logoGlowDark 1.4s infinite alternate; }
    @keyframes logoGlowDark { 0% { box-shadow: 0 0 0 0 #6366f1, 0 0 32px 8px #6366f1cc, 0 0 64px 24px #818cf8cc, 4px 4px 16px #181c2f, -4px -4px 16px #23243a, 0 1.5px 0 #23243a inset; } 100% { box-shadow: 0 0 0 18px #6366f1, 0 0 64px 32px #6366f1cc, 0 0 128px 48px #818cf8cc, 4px 4px 16px #181c2f, -4px -4px 16px #23243a, 0 1.5px 0 #23243a inset; } }
    .room-floor { position: absolute; left: 0; right: 0; bottom: 0; height: 32vh; background: linear-gradient(0deg, var(--floor-bg) 0%, var(--floor-bg2) 100%); z-index: 0; border-top-left-radius: 60vw 10vh; border-top-right-radius: 60vw 10vh; box-shadow: 0 -8px 32px var(--shadow) inset; opacity: 0.85; transition: background 0.5s, box-shadow 0.5s; }
    .room-shadow { position: absolute; left: 50%; bottom: 18vh; width: 260px; height: 48px; background: radial-gradient(ellipse at center, var(--shadow) 0%, #0000 80%); transform: translateX(-50%) scaleY(1.1); filter: blur(4px); z-index: 2; pointer-events: none; opacity: 0.7; transition: left 0.2s, width 0.2s, opacity 0.2s, background 0.5s; }
    .login-3d-container { perspective: 1600px; width: 100vw; transform: translateY(-1vh); height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 3; position: relative; }
    .login-3d-box { background: var(--box-bg); border-radius: 32px; box-shadow: 8px 8px 24px var(--box-shadow1), -8px -8px 24px var(--box-shadow2), 0 1.5px 0 var(--box-shadow3) inset, 0 0 0 1.5px var(--box-shadow4); border: none; padding: 38px 24px 28px 24px; min-width: 320px; max-width: 92vw; width: 350px; display: flex; flex-direction: column; align-items: center; transform-style: preserve-3d; animation: pop3d 1.1s cubic-bezier(.68,-0.55,.27,1.55); position: relative; transition: box-shadow 0.3s, transform 0.2s, background 0.5s; will-change: transform; z-index: 10; overflow: visible; }
    @keyframes pop3d { 0% { transform: rotateY(30deg) scale(0.7) translateY(60px); opacity: 0; } 80% { transform: rotateY(-8deg) scale(1.05) translateY(-8px); opacity: 1; } 100% { transform: rotateY(0deg) scale(1) translateY(0); opacity: 1; } }
    .logo-row { display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 18px; gap: 12px; }
    .login-3d-title { font-size: 1.25em; font-weight: 800; color: var(--title); letter-spacing: .04em; margin-bottom: 18px; text-shadow: 0 2px 4px var(--title-shadow1), 0 1px 0 var(--title-shadow2); text-align: center; z-index: 2; position: relative; transition: color 0.5s, text-shadow 0.5s; }
    .login-3d-fields { width: 100%; display: flex; flex-direction: column; gap: 14px; margin-bottom: 18px; align-items: center; }
    .login-3d-fields input[type="text"], .login-3d-fields input[type="password"], .login-3d-fields input[type="date"], .login-3d-fields input[type="email"] { width: 100%; min-width: 0; max-width: 100%; box-sizing: border-box; padding: 13px 16px; border-radius: 12px; border: none; font-size: 1.08em; background: var(--input-bg); color: var(--input-color); outline: none; box-shadow: 4px 4px 12px var(--input-shadow1), -4px -4px 12px var(--input-shadow2), 0 1.5px 0 var(--input-shadow3) inset; font-family: inherit; font-weight: 500; transition: box-shadow .2s, background .2s, color 0.5s; display: block; }
    .login-3d-fields input:focus { background: var(--input-focus-bg); box-shadow: 2px 2px 6px var(--input-focus-shadow1), -2px -2px 6px var(--input-focus-shadow2), 0 2px 8px var(--input-focus-shadow3); }
    .profile-img-preview { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; margin: 8px auto 0 auto; display: block; border: 2px solid var(--profile-border); background: var(--profile-bg); box-shadow: 2px 2px 8px var(--profile-shadow1), -2px -2px 8px var(--profile-shadow2); transition: border 0.5s, background 0.5s; }
    .login-3d-btn { margin-top: 8px; width: 100%; min-width: 0; max-width: 100%; box-sizing: border-box; background: var(--btn-bg); color: var(--btn-color); border: none; border-radius: 14px; padding: 13px 0; font-size: 1.12em; font-weight: 700; box-shadow: 4px 4px 12px var(--btn-shadow1), -4px -4px 12px var(--btn-shadow2); cursor: pointer; opacity: 0.96; letter-spacing: .04em; transition: opacity .2s, box-shadow .2s, transform .1s, background 0.5s, color 0.5s; display: block; }
    .login-3d-btn:active { opacity: 1; box-shadow: 2px 2px 6px var(--btn-shadow1), -2px -2px 6px var(--btn-shadow2); transform: scale(0.98); }
    .login-3d-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .login-3d-msg { min-height: 20px; text-align: center; color: var(--msg); font-weight: 600; margin-top: 10px; text-shadow: 0 2px 8px var(--msg-shadow); letter-spacing: .02em; font-size: 1em; transition: color 0.2s; }
    .switch-link { margin-top: 14px; font-size: 0.98em; color: var(--switch-link); text-align: center; cursor: pointer; text-decoration: underline; transition: color 0.5s; }
    .hide { display: none !important; }
    .input-error { box-shadow: 0 0 0 2px #dc2626, 4px 4px 12px var(--box-shadow1), -4px -4px 12px var(--box-shadow2), 0 1.5px 0 var(--box-shadow3) inset !important; background: #fee2e2 !important; animation: shake 0.18s 2; }
    @keyframes shake { 0% { transform: translateX(0);} 25% { transform: translateX(-4px);} 50% { transform: translateX(4px);} 75% { transform: translateX(-4px);} 100% { transform: translateX(0);} }
    .profile-popup { position: fixed; inset: 0; background: rgba(30, 41, 59, 0.18); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.35s; }
    .profile-popup.open { opacity: 1; pointer-events: auto; }
    .popup-content { position: relative; background: var(--popup-bg); border-radius: 999px; box-shadow: 0 8px 40px var(--popup-shadow); width: 92vw; max-width: 420px; height: 70vh; max-height: 520px; display: flex; flex-direction: column; align-items: stretch; justify-content: flex-start; opacity: 0; transform: scale(0.3); transition: opacity 0.45s cubic-bezier(.68,-0.55,.27,1.55), transform 0.45s cubic-bezier(.68,-0.55,.27,1.55), transform-origin 0s; will-change: opacity, transform; }
    .profile-popup.open .popup-content { opacity: 1; transform: scale(1); pointer-events: auto; }
    .popup-iframe { flex: 1 1 auto; border: none; width: 100%; height: 100%; border-radius: 20px; background: #f3f4f6; }
    .popup-close { position: absolute; top: 10px; left: 10px; background: var(--popup-close-bg); border: none; border-radius: 50%; width: 38px; height: 38px; box-shadow: 0 2px 8px var(--popup-close-shadow); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; transition: background 0.2s; }
    .popup-close:hover { background: var(--popup-close-hover-bg); }
    .popup-close svg path { transition: stroke 0.2s; stroke: var(--popup-close-path); }
    .popup-close:hover svg path { stroke: var(--popup-close-hover-path); }
    @media (max-width: 500px) { .login-3d-box { min-width: 90vw; width: 96vw; padding: 14px 2vw 10px 2vw;} .login-3d-logo { width: 40px; height: 40px; } .room-shadow { width: 120px; height: 22px; bottom: 14vh;} .login-3d-fields input, .login-3d-btn { max-width: 100vw; } .popup-content { max-width: 98vw; height: 80vh; } }
    .dob-label { display: block; margin-bottom: 4px; color: #a5b4fc; font-size: 1.01em; font-weight: 600; opacity: 0.8; letter-spacing: 0.01em; font-family: 'Inter', Arial, sans-serif; }
    .dob-field-wrap, .pass-field-wrap { width: 100%; }
    #google-auth-container { width: 100%; margin-top: 10px; }
    .google-account-button { width: 100%; box-sizing: border-box; background: #fff; color: #222; border: 1px solid var(--btn-shadow1); border-radius: 14px; padding: 8px 12px; box-shadow: 4px 4px 12px var(--btn-shadow1), -4px -4px 12px var(--btn-shadow2); cursor: pointer; transition: opacity .2s, box-shadow .2s, transform .1s, background 0.5s, color 0.5s; display: flex; align-items: center; gap: 12px; }
    .google-account-button:active { opacity: 1; box-shadow: 2px 2px 6px var(--btn-shadow1), -2px -2px 6px var(--btn-shadow2); transform: scale(0.98); }
    .google-account-button img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid var(--profile-border); }
    .google-account-button .user-details { text-align: left; line-height: 1.3; }
    .google-account-button .user-name { font-weight: 700; font-size: 1.05em; color: var(--title); }
    .google-account-button .user-email { font-size: 0.9em; color: var(--switch-link); }
    body.dark-mode .google-account-button { background: var(--input-bg); border-color: #6366f1; box-shadow: 6px 6px 16px #181c2f, -6px -6px 16px #23243a, 0 0 0 2px #6366f1; }
    
    /* --- NEW CSS FOR OFFLINE INDICATOR --- */
    #offline-indicator {
        position: fixed;
        inset: 0;
        z-index: 9999;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(30, 41, 59, 0.3);
        backdrop-filter: blur(8px) saturate(1.1);
        opacity: 0;
        transition: opacity 0.5s;
    }
    #offline-indicator.visible {
        display: flex;
        opacity: 1;
    }
    .offline-scene {
        position: relative;
        width: 250px;
        height: 150px;
    }
    .offline-phone {
        width: 70px;
        height: 120px;
        background: var(--box-bg);
        border: 4px solid var(--title);
        border-radius: 12px;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        box-shadow: var(--box-shadow1);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .offline-phone::after { /* Phone's home button */
        content: '';
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--title);
        position: absolute;
        bottom: 8px;
    }
    .internet-wire {
        position: absolute;
        bottom: 40px;
        left: -80px;
        width: 100px;
        height: 4px;
        background: #3730a3;
        border-radius: 2px;
        transform-origin: right center;
        animation: tryToConnect 3s cubic-bezier(0.65, 0, 0.35, 1) infinite;
    }
    .wire-plug {
        width: 12px;
        height: 18px;
        background: #a5b4fc;
        border: 3px solid #3730a3;
        border-radius: 4px;
        position: absolute;
        right: -10px;
        top: 50%;
        transform: translateY(-50%);
    }
    .wire-plug::before, .wire-plug::after { /* The two prongs */
        content: '';
        position: absolute;
        width: 2px;
        height: 6px;
        background: #3730a3;
        top: 3px;
    }
    .wire-plug::before { left: 2px; }
    .wire-plug::after { right: 2px; }

    @keyframes tryToConnect {
        0%, 100% { transform: translateX(0) rotate(15deg); }
        40% { transform: translateX(120px) rotate(0deg); }
        50% { transform: translateX(115px) rotate(0deg); }
        60% { transform: translateX(120px) rotate(0deg); }
        70% { transform: translateX(115px) rotate(0deg); }
        80% { transform: translateX(120px) rotate(0deg); }
        90% { transform: translateX(0) rotate(15deg); }
    }
    .offline-message {
        margin-top: 20px;
        font-size: 1.2em;
        font-weight: 700;
        color: var(--title);
        text-shadow: 0 1px 2px var(--title-shadow2);
        background: var(--box-bg);
        padding: 8px 16px;
        border-radius: 12px;
        box-shadow: var(--box-shadow1);
    }
  </style>
</head>
<body>
  
  <div id="modeSwitchBtn" title="Switch UI Mode">
    <svg id="modeSwitchIcon" width="32" height="32" viewBox="0 0 32 32" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <g class="sun-and-moon">
            <mask id="moon-mask">
                <rect x="0" y="0" width="100%" height="100%" fill="white" />
                <circle cx="24" cy="10" r="8" fill="black" />
            </mask>
            <circle class="moon" cx="16" cy="16" r="8" fill="#6366f1" mask="url(#moon-mask)"></circle>
            <g class="sun-rays">
                <line x1="16" y1="3" x2="16" y2="7"></line>
                <line x1="16" y1="25" x2="16" y2="29"></line>
                <line x1="6.86" y1="6.86" x2="9.69" y2="9.69"></line>
                <line x1="22.31" y1="22.31" x2="25.14" y2="25.14"></line>
                <line x1="3" y1="16" x2="7" y2="16"></line>
                <line x1="25" y1="16" x2="29" y2="16"></line>
                <line x1="6.86" y1="25.14" x2="9.69" y2="22.31"></line>
                <line x1="22.31" y1="9.69" x2="25.14" y2="6.86"></line>
            </g>
        </g>
    </svg>
  </div>
  <div id="modeWave"></div>
  <div class="room-floor"></div>
  <div class="room-shadow"></div>

  <div class="login-3d-container">
    <form class="login-3d-box" id="signupCard" autocomplete="off" onsubmit="return false;">
      <div class="logo-row">
        <img src="Zenstudy.jpg" class="login-3d-logo" alt="logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135755.png'">
      </div>
      <div class="login-3d-title" id="signupTitle">Create Your Account</div>
      
      <div class="login-3d-fields" id="signupFields">
        <input type="email" id="signupEmail" placeholder="Your Email Address" autocomplete="off" required>
        <div class="pass-field-wrap">
            <input type="password" id="signupPass" placeholder="Create password (min 6 chars)" autocomplete="off" required>
        </div>
        <div class="dob-field-wrap">
          <label for="signupDOB" class="dob-label">Date of Birth</label>
          <input type="date" id="signupDOB" required autocomplete="off">
        </div>
      </div>

      <div id="google-auth-container">
        <button type="button" id="googleConnectBtn" class="login-3d-btn" style="background:#fff;color:#222;border:1px solid #6366f1;">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:22px;vertical-align:middle;margin-right:8px;">
          <span id="googleBtnText">Connect Google Account</span>
        </button>
        <div id="googleAccountInfo" class="google-account-button hide">
          <img id="googleUserPic">
          <div class="user-details">
            <span id="googleUserName" class="user-name"></span><br>
            <span id="googleUserEmail" class="user-email"></span>
          </div>
        </div>
      </div>
      
      <div class="login-3d-msg" id="signupMsg">Please fill all fields and connect Google.</div>
      <button class="login-3d-btn" id="signupBtn" type="button" disabled>Sign Up</button>
      <div class="switch-link" id="toLogin">Already have an account? Login</div>
    </form>
    
    <form class="login-3d-box hide" id="loginCard" autocomplete="off" onsubmit="return false;">
      <div class="logo-row">
        <img src="https://cdn-icons-png.flaticon.com/512/3135/3135755.png" class="login-3d-logo" alt="logo">
      </div>
      <div class="login-3d-title" id="loginTitle">Login</div>
      <div class="login-3d-fields">
        <input type="email" id="loginEmail" placeholder="Email Address" autocomplete="off" required>
        <input type="password" id="loginPass" placeholder="Password" autocomplete="off" required>
      </div>
      <button type="button" id="googleLoginBtnLogin" class="login-3d-btn" style="margin-top:10px;background:#fff;color:#222;border:1px solid #6366f1;">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:22px;vertical-align:middle;margin-right:8px;"> Sign in with Google
      </button>
      <div class="login-3d-msg" id="loginMsg"></div>
      <button class="login-3d-btn" id="loginBtn" type="button">Login</button>
      <div class="switch-link" id="toSignup">Don't have an account? Sign Up</div>
    </form>
    
  </div>
  
  <div id="profilePopup" class="profile-popup">
    <div class="popup-content">
      <button class="popup-close" id="popupCloseBtn" aria-label="Close"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="M20 24L12 16L20 8" stroke="#6366f1" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
      <iframe src="help.html" frameborder="0" class="popup-iframe"></iframe>
    </div>
  </div>
  
  <div id="offline-indicator">
      <div class="offline-scene">
          <div class="offline-phone"></div>
          <div class="internet-wire">
              <div class="wire-plug"></div>
          </div>
      </div>
      <div class="offline-message">Connection Failed :(</div>
  </div>
<script>
// INITIAL REDIRECT LOGIC - Use last_logged_in_user and look up in storage
const lastUser = localStorage.getItem("last_logged_in_user");

if (lastUser) {
  // Check if user data exists locally for the last logged-in user
  const userData = localStorage.getItem("user_" + lastUser);
  
  if (userData) {
    // If user data exists, redirect to main page using the stored UID
    window.location.replace(`main.html?user=${encodeURIComponent(lastUser)}`);
  }
}
</script>
<script>

  /**
 * ==========================================
 * 1. FIREBASE CONFIGURATION & INITIALIZATION
 * ==========================================
 */
const firebaseConfig = {
    apiKey: "AIzaSyC9rehsf-0jkb9dAeT1-0Z1C-yRJ0YI9dA",
    authDomain: "gymnm-ce84b.firebaseapp.com",
    projectId: "gymnm-ce84b",
    storageBucket: "gymnm-ce84b.appspot.com",
    messagingSenderId: "474926929394",
    appId: "1:474926929394:web:6abdb807caba2751a5c76b",
    measurementId: "G-6R9S8LYZNF"
};

// Initialize Firebase only if not already initialized
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
const auth = firebase.auth(); // Added Auth instance

/**
 * ==========================================
 * 2. UTILITY FUNCTIONS (Storage, Math, Helpers)
 * ==========================================
 */

// Theme Storage
function saveModeToStorage(modeIdx) {
    localStorage.setItem('ui_mode', modeIdx);
}

function getModeFromStorage() {
    const idx = localStorage.getItem('ui_mode');
    return idx === null ? 0 : parseInt(idx, 10);
}

// Random String Generator (Not used anymore since unique IDs are handled by Firebase Auth UID)
/*
function generateRandomChars(length) {
    const characters = 'abcdefghijklmnopqrstuvwxyz';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}
*/

// Age Validation
function isAgeBetween7And21(dobStr) {
    if (!dobStr) return false;
    const dob = new Date(dobStr);
    const today = new Date();
    if (dob > today) return false;
    
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
    
    return age >= 7 && age <= 21;
}

// Image to Base64 Converter (with Error Handling)
async function imageUrlToBase64(url) {
    try {
        const response = await fetch(url);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    } catch (error) {
        console.warn("Could not convert Google image (likely CORS):", error);
        return null; 
    }
}

/**
 * ==========================================
 * 3. AUTO-REDIRECT LOGIC (Already above, kept clean)
 * ==========================================
 */

// Your existing redirect logic is fine.

/**
 * ==========================================
 * 4. THEME & VISUALS LOGIC
 * ==========================================
 */
const modeSwitchBtn = document.getElementById('modeSwitchBtn');
const modeWave = document.getElementById('modeWave');
const modes = [
    { class: "", color: "#6366f1", tooltip: "Switch to Dark Mode" },
    { class: "dark-mode", color: "#818cf8", tooltip: "Switch to Light Mode" }
];

let modeIndex = getModeFromStorage();

function setMode(idx) {
    document.body.classList.remove("dark-mode");
    if (modes[idx].class) document.body.classList.add(modes[idx].class);
    if (modeSwitchBtn) modeSwitchBtn.title = modes[idx].tooltip;
    modeIndex = idx;
    saveModeToStorage(idx);
}

function waterWaveTransition(nextModeIdx) {
    const btnRect = modeSwitchBtn.getBoundingClientRect();
    const cx = btnRect.left + btnRect.width / 2;
    const cy = btnRect.top + btnRect.height / 2;
    const maxDist = Math.max(
        Math.hypot(cx, cy), 
        Math.hypot(window.innerWidth - cx, cy), 
        Math.hypot(cx, window.innerHeight - cy), 
        Math.hypot(window.innerWidth - cx, window.innerHeight - cy)
    );

    function wavePath(r, waviness = 18, waves = 8) {
        let d = "";
        for (let i = 0; i <= 360; i += 2) {
            const rad = i * Math.PI / 180;
            const wave = Math.sin(rad * waves) * waviness;
            const x = cx + (r + wave) * Math.cos(rad);
            const y = cy + (r + wave) * Math.sin(rad);
            d += (i === 0 ? "M" : "L") + x + "," + y + " ";
        }
        d += "Z";
        return d;
    }

    modeWave.innerHTML = `<svg><path id="wavePath" fill="${nextModeIdx === 1 ? '#6366f1' : '#fff'}" fill-opacity="0.92"/></svg>`;
    modeWave.style.opacity = "1";
    
    const path = document.getElementById("wavePath");
    let step = 0, totalSteps = 38;

    function animateWave() {
        const r = (step / totalSteps) * (maxDist + 120);
        path.setAttribute("d", wavePath(r));
        
        if (step === Math.floor(totalSteps / 2)) {
            setMode(nextModeIdx);
        }
        
        if (step < totalSteps) {
            step++;
            requestAnimationFrame(animateWave);
        } else {
            setTimeout(() => { modeWave.style.opacity = "0"; }, 180);
        }
    }
    animateWave();
}

// Initialize Theme
setMode(modeIndex);
if (modeSwitchBtn) {
    modeSwitchBtn.onclick = function(e) {
        const nextIdx = (modeIndex + 1) % modes.length;
        waterWaveTransition(nextIdx, e);
    };
}

/**
 * ==========================================
 * 5. 3D MOTION & GYROSCOPE LOGIC (UNCHANGED)
 * ==========================================
 */
const motionHandler = { listener: null };

function setup3d(cardSelector, shadowSelector) {
    const card = document.querySelector(cardSelector);
    if (!card) return;
    const shadow = document.querySelector(shadowSelector);
    
    const MOUSE_SENSITIVITY = 0.07;
    const GYRO_SENSITIVITY = 0.6;
    const GYRO_ACCELERATION_FACTOR = 1.4;
    
    let targetX = 0, targetY = 0, currentX = 0, currentY = 0;
    let isCursorInside = false;
    let usingGyro = false;
    let animating = false;
    let neutralBeta = null;
    let neutralGamma = null;

    motionHandler.listener = (event) => {
        if (!event.gamma || !event.beta || !usingGyro) return;
        if (neutralBeta === null) {
            neutralBeta = event.beta;
            neutralGamma = event.gamma;
            return;
        }
        let deltaBeta = event.beta - neutralBeta;
        let deltaGamma = event.gamma - neutralGamma;
        let moveY = Math.sign(deltaBeta) * Math.pow(Math.abs(deltaBeta), GYRO_ACCELERATION_FACTOR);
        let moveX = Math.sign(deltaGamma) * Math.pow(Math.abs(deltaGamma), GYRO_ACCELERATION_FACTOR);
        targetY = -moveY * GYRO_SENSITIVITY;
        targetX = moveX * GYRO_SENSITIVITY;
        if (!animating) requestAnimationFrame(animateCard);
    };

    document.body.addEventListener('mousemove', e => {
        if (usingGyro || isCursorInside) return;
        const rect = card.getBoundingClientRect();
        targetX = (e.clientX - rect.left - rect.width / 2) * MOUSE_SENSITIVITY;
        targetY = -(e.clientY - rect.top - rect.height / 2) * MOUSE_SENSITIVITY;
        if (!animating) requestAnimationFrame(animateCard);
    });

    card.addEventListener('mouseenter', () => {
        if (usingGyro) return;
        isCursorInside = true;
        targetX = 0;
        targetY = 0;
        if (!animating) requestAnimationFrame(animateCard);
    });

    card.addEventListener('mouseleave', (e) => {
        if (usingGyro) return;
        isCursorInside = false;
        const rect = card.getBoundingClientRect();
        targetX = (e.clientX - rect.left - rect.width / 2) * MOUSE_SENSITIVITY;
        targetY = -(e.clientY - rect.top - rect.height / 2) * MOUSE_SENSITIVITY;
        if (!animating) requestAnimationFrame(animateCard);
    });

    function animateCard() {
        animating = true;
        currentX += (targetX - currentX) * 0.1;
        currentY += (targetY - currentY) * 0.1;
        card.style.transform = `rotateY(${currentX}deg) rotateX(${currentY}deg)`;
        
        if (shadow) {
            shadow.style.left = `calc(50% + ${-currentX * 4}px)`;
            shadow.style.opacity = `${0.7 - Math.abs(currentY / 50)}`;
        }
        
        if (Math.abs(currentX - targetX) > 0.01 || Math.abs(currentY - targetY) > 0.01) {
            requestAnimationFrame(animateCard);
        } else {
            animating = false;
        }
    }
    animateCard();

    function startGyro() {
        if (motionHandler.listener) {
            usingGyro = true;
            window.addEventListener('deviceorientation', motionHandler.listener, true);
        }
    }

    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission !== 'function') {
        startGyro();
    }
}

function requestMotionPermission() {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(permissionState => {
                if (permissionState === 'granted') {
                    if (motionHandler.listener) {
                        document.querySelectorAll('.login-3d-box').forEach(card => {
                             // This part is fine for now
                        });
                        window.addEventListener('deviceorientation', motionHandler.listener, true);
                    }
                }
            })
            .catch(console.error);
    }
}
window.addEventListener('click', requestMotionPermission, { once: true });

// Initialize 3D Effect
setup3d('#signupCard', '.room-shadow');
setup3d('#loginCard', '.room-shadow');

/**
 * ==========================================
 * 6. UI HANDLERS (Switching Cards, Popups) (UNCHANGED)
 * ==========================================
 */
const signupCard = document.getElementById('signupCard');
const loginCard = document.getElementById('loginCard');
const toLoginBtn = document.getElementById('toLogin');
const toSignupBtn = document.getElementById('toSignup');
const popup = document.getElementById('profilePopup');
const popupCloseBtn = document.getElementById('popupCloseBtn');
const logoImgs = document.querySelectorAll('.login-3d-logo');

if (toLoginBtn) {
    toLoginBtn.onclick = () => {
        // Clear login card messages on switch
        loginMsg.textContent = "";
        signupCard.classList.add('hide');
        loginCard.classList.remove('hide');
    };
}

if (toSignupBtn) {
    toSignupBtn.onclick = () => {
        // Clear signup card messages on switch
        signupMsg.textContent = "Please fill all fields and connect Google.";
        loginCard.classList.add('hide');
        signupCard.classList.remove('hide');
    };
}

// Popup Logic
logoImgs.forEach(logo => {
    logo.addEventListener('click', () => {
        if (popup) popup.classList.toggle('open');
    });
});

if (popupCloseBtn) {
    popupCloseBtn.addEventListener('click', () => popup.classList.remove('open'));
}

if (popup) {
    popup.addEventListener('click', e => {
        if (e.target === popup) popup.classList.remove('open');
    });
}

/**
 * ==========================================
 * 7. AUTHENTICATION LOGIC (Signup & Login)
 * ==========================================
 */

// --- Signup Elements ---
// CHANGED: signupUser to signupEmail
const signupEmail = document.getElementById('signupEmail');
const signupPass = document.getElementById('signupPass');
const signupDOB = document.getElementById('signupDOB');
const signupBtn = document.getElementById('signupBtn');
const signupMsg = document.getElementById('signupMsg');

const googleConnectBtn = document.getElementById('googleConnectBtn');
const googleAccountInfo = document.getElementById('googleAccountInfo');
const googleUserPic = document.getElementById('googleUserPic');
const googleUserName = document.getElementById('googleUserName');
const googleUserEmail = document.getElementById('googleUserEmail');

// --- Login Elements ---
// CHANGED: loginUser to loginEmail
const loginEmail = document.getElementById('loginEmail');
const loginPass = document.getElementById('loginPass');
const loginBtn = document.getElementById('loginBtn');
const loginMsg = document.getElementById('loginMsg');
const googleLoginBtnLogin = document.getElementById('googleLoginBtnLogin');


// --- State ---
let googleUser = null;
let isGoogleSigningIn = false; 

// --- Validation Logic (Signup) ---
function checkSignupFields() {
    if (!signupEmail || !signupPass || !signupDOB) return;

    // CHANGED: Check for email instead of custom username
    const isEmailFilled = signupEmail.value.trim().length > 0;
    const isPassFilled = signupPass.value.length >= 6;
    const isDOBFilled = signupDOB.value;
    const isValidAge = isAgeBetween7And21(signupDOB.value);
    const isGoogleConnected = googleUser !== null;

    const allConditionsMet = isEmailFilled && isPassFilled && isDOBFilled && isValidAge; // Google is optional for custom signup
    
    // We only enable signup if email/pass/dob is valid, *or* if a Google user is connected.
    // However, the original logic forces Google connect, so we'll keep that for now.
    const allRequiredMet = allConditionsMet && isGoogleConnected;

    if (signupBtn) signupBtn.disabled = !allRequiredMet;

    if (isDOBFilled && !isValidAge) {
        signupMsg.textContent = "Age must be between 7 and 21.";
    } else if (!isGoogleConnected) {
        signupMsg.textContent = "Please fill all fields and connect Google.";
    } else if (!allConditionsMet) {
        signupMsg.textContent = "Please fill all required fields (Email, Password, DOB).";
    } else {
        signupMsg.textContent = "Ready to Sign Up!";
    }
}

// Attach Listeners to Inputs
// CHANGED: Listen to signupEmail instead of signupUser
if (signupEmail) signupEmail.oninput = checkSignupFields;
if (signupPass) signupPass.oninput = checkSignupFields;
if (signupDOB) signupDOB.oninput = checkSignupFields;


// --- Google Connect Logic (Signup) ---
async function connectGoogle(promptForAccount = false) {
    if (isGoogleSigningIn) return;
    isGoogleSigningIn = true;

    const provider = new firebase.auth.GoogleAuthProvider();
    if (promptForAccount) {
        provider.setCustomParameters({ prompt: "select_account" });
    }

    signupMsg.textContent = "Opening Google...";

    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user; // Firebase Auth User

        // Check if the user already exists in Firestore by their UID
        const userCheck = await db.collection('users').doc(user.uid).get();

        if (userCheck.exists) {
            signupMsg.innerHTML = "⚠️ This Google account is already registered.<br>Please login.";
            googleConnectBtn.classList.remove("hide");
            googleAccountInfo.classList.add("hide");
            googleUser = null;
            checkSignupFields();
            return;
        }
        
        googleUser = user;

        // Update UI
        googleUserPic.src = user.photoURL || "https://cdn-icons-png.flaticon.com/512/3135/3135755.png";
        googleUserName.textContent = user.displayName || "Google User";
        googleUserEmail.textContent = user.email || "No email provided";

        googleConnectBtn.classList.add("hide");
        googleAccountInfo.classList.remove("hide");

        signupMsg.textContent = "Google Account Connected ✔";
        checkSignupFields();

    } catch (err) {
        console.error(err);
        // User closed the popup or other error
        signupMsg.textContent = "Google connection failed.";
    } finally {
        isGoogleSigningIn = false;
    }
}

if (googleConnectBtn) {
    googleConnectBtn.onclick = () => connectGoogle(true);
}

if (googleAccountInfo) {
    googleAccountInfo.onclick = () => connectGoogle(true); // Forces re-selection
}


// --- Final Signup Logic (Email/Password & Google) ---
if (signupBtn) {
    signupBtn.onclick = async function() {
        if (signupBtn.disabled || !googleUser) return;

        const email = signupEmail.value.trim();
        const password = signupPass.value;

        signupBtn.disabled = true;
        signupMsg.textContent = "Creating your account...";

        try {
            // 1. Create user in Firebase Authentication
            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;
            const uid = user.uid; // Use Firebase UID as the unique identifier

            // 2. Attempt to convert image
            let imgBase64 = null;
            if (googleUser.photoURL) {
                imgBase64 = await imageUrlToBase64(googleUser.photoURL);
            }

            // 3. Prepare user data for Firestore
            // We use the connected Google account's name/photo for the initial profile, 
            // but the email/password for auth. The email/name are the most reliable.
            const userData = {
                uid: uid,
                email: user.email,
                username: googleUser.displayName || 'New User', // Use Google name as initial username
                dob: signupDOB.value,
                // SECURITY FIX: Password is NOT stored in Firestore! It's handled by Firebase Auth.
                img: imgBase64, 
                googleEmail: googleUser.email,
                googleName: googleUser.displayName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // 4. Write to Firestore using the secure UID
            await db.collection('users').doc(uid).set(userData);
            
            // 5. Save local session
            localStorage.setItem("user_" + uid, JSON.stringify(userData));
            localStorage.setItem("last_logged_in_user", uid); // FIXED: Added missing local storage set

            signupMsg.innerHTML = `Success! Welcome, ${userData.username}<br>Redirecting...`;

            setTimeout(() => {
                window.location.replace(`main.html?user=${encodeURIComponent(uid)}`);
            }, 1000);

        } catch (err) {
            console.error(err);
            let errorMessage = "Signup error.";
            // Map Firebase errors to user-friendly messages
            if (err.code === 'auth/email-already-in-use') {
                errorMessage = "This email is already in use. Please login or use a different email.";
                signupEmail.classList.add('input-error');
            } else if (err.code === 'auth/invalid-email') {
                errorMessage = "The email address is not valid.";
                signupEmail.classList.add('input-error');
            } else if (err.code === 'auth/weak-password') {
                errorMessage = "The password is too weak. Must be at least 6 characters.";
                signupPass.classList.add('input-error');
            } else {
                errorMessage += ` (${err.message})`;
            }

            signupMsg.textContent = errorMessage;
            signupBtn.disabled = false;
        } finally {
            signupEmail.classList.remove('input-error');
            signupPass.classList.remove('input-error');
        }
    };
}


// --- LOGIN LOGIC IMPLEMENTATION ---

// 1. Traditional Login Handler (using Firebase Email/Password)
if (loginBtn) {
    loginBtn.onclick = async function() {
        const email = loginEmail.value.trim();
        const password = loginPass.value;

        if (!email || !password) {
            loginMsg.textContent = "Please enter both Email and Password.";
            return;
        }

        loginBtn.disabled = true;
        loginMsg.textContent = "Logging in...";

        try {
            // SECURITY FIX: Use Firebase Auth for sign-in
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            const uid = user.uid;

            // Fetch custom data from Firestore using the UID
            const userDoc = await db.collection('users').doc(uid).get();

            if (!userDoc.exists) {
                // This shouldn't happen if Firebase Auth succeeded, but good to check
                loginMsg.textContent = "User data not found in database. Contact support.";
                await auth.signOut(); // Log out the user from Firebase Auth
                return;
            }

            const userData = userDoc.data();

            // Success
            localStorage.setItem("user_" + uid, JSON.stringify(userData));
            localStorage.setItem("last_logged_in_user", uid); // FIXED: Added missing local storage set

            loginMsg.textContent = "Login successful. Redirecting...";

            setTimeout(() => {
                window.location.replace(`main.html?user=${encodeURIComponent(uid)}`);
            }, 500);

        } catch (err) {
            console.error(err);
            let errorMessage = "Login failed.";
            if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                 errorMessage = "Invalid email or password.";
                 loginEmail.classList.add('input-error');
                 loginPass.classList.add('input-error');
            } else if (err.code === 'auth/invalid-email') {
                errorMessage = "The email address is not valid.";
                loginEmail.classList.add('input-error');
            } else {
                errorMessage += ` (${err.message})`;
            }
            
            loginMsg.textContent = errorMessage;

        } finally {
            loginBtn.disabled = false;
            loginEmail.classList.remove('input-error');
            loginPass.classList.remove('input-error');
        }
    };
}


// 2. Google Login on Login Card Handler
if (googleLoginBtnLogin) {
    googleLoginBtnLogin.onclick = async function() {
        if (isGoogleSigningIn) return;
        isGoogleSigningIn = true;
        loginMsg.textContent = "Opening Google Sign-in...";
        googleLoginBtnLogin.disabled = true;

        const provider = new firebase.auth.GoogleAuthProvider();
        
        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user; // Firebase Auth User
            const uid = user.uid;

            // Check if the user's data is linked in Firestore by their UID
            const userDoc = await db.collection('users').doc(uid).get();

            if (userDoc.empty || !userDoc.exists) {
                // The Google account is authenticated with Firebase Auth, 
                // but their custom profile data is missing in Firestore.
                // Log them out and prompt to sign up properly.
                await auth.signOut();
                loginMsg.innerHTML = "⚠️ No full account profile found. Please sign up first.";
                googleLoginBtnLogin.disabled = false;
                return;
            }
            
            // Account found! Log them in.
            const userData = userDoc.data();

            // Save full user data locally for main.html
            localStorage.setItem("user_" + uid, JSON.stringify(userData));
            localStorage.setItem("last_logged_in_user", uid); // FIXED: Set last_logged_in_user

            loginMsg.textContent = "Google Login successful. Redirecting...";

            setTimeout(() => {
                window.location.replace(`main.html?user=${encodeURIComponent(uid)}`);
            }, 500);
        } catch (err) {
            console.error(err);
            loginMsg.textContent = "Google login error. Please try again or use email/password.";
        } finally {
            isGoogleSigningIn = false;
            googleLoginBtnLogin.disabled = false;
        }
    };
}

// Clear error state on input
// CHANGED: Listen to loginEmail instead of loginUser
if (loginEmail) loginEmail.oninput = () => loginEmail.classList.remove('input-error');
if (loginPass) loginPass.oninput = () => loginPass.classList.remove('input-error');


</script>
</body>
</html>
